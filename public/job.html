<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Job Details - Job Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .mobile-optimized {
                padding: 1rem;
            }
            .mobile-text {
                font-size: 0.875rem;
            }
            .mobile-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
        }
        
        /* Prevent zoom on input focus for iOS */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* Touch-friendly buttons */
        button, .btn {
            min-height: 44px;
            min-width: 44px;
        }

        /* Phone number input styling */
        .phone-input {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
        }

        .phone-input:invalid {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .phone-input:valid {
            border-color: #10b981;
        }

        /* Error styling */
        .error-text {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .success-text {
            color: #10b981;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="app">
        <!-- Loading State -->
        <div id="loading" class="min-h-screen flex items-center justify-center mobile-optimized">
            <div class="text-center bg-white p-8 rounded-2xl card-shadow max-w-sm w-full">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">Loading job details...</p>
                <p class="text-gray-500 text-sm mt-2">Please wait while we fetch your job information</p>
            </div>
        </div>

        <!-- Error State -->
        <div id="error" class="min-h-screen flex items-center justify-center p-4 hidden">
            <div class="text-center max-w-md mx-auto bg-white p-8 rounded-2xl card-shadow">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Connection Issue</h1>
                <p class="text-gray-600 mb-4" id="error-message">Unable to connect to the job management system.</p>
                <p class="text-sm text-gray-500 mb-4">This may be due to network connectivity or server availability.</p>
                <button onclick="window.location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Try Again
                </button>
            </div>
        </div>

        <!-- Success Toast -->
        <div id="success-toast" class="fixed top-4 right-4 z-50 max-w-sm w-full hidden">
            <div class="bg-green-50 border border-green-200 rounded-xl p-4 shadow-lg">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-green-700 font-medium" id="success-message">Success!</p>
                </div>
            </div>
        </div>

        <!-- Error Toast -->
        <div id="error-toast" class="fixed top-4 right-4 z-50 max-w-sm w-full hidden">
            <div class="bg-red-50 border border-red-200 rounded-xl p-4 shadow-lg">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <p class="text-red-700 font-medium" id="error-toast-message">Error occurred!</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="content" class="hidden">
            <!-- Header -->
            <div class="bg-white shadow-lg border-b border-gray-200 sticky top-0 z-10">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="py-4 sm:py-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h1 id="job-title" class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900"></h1>
                                <p id="job-date" class="text-sm text-gray-600 mt-1"></p>
                                <div class="flex items-center space-x-2 mt-2">
                                    <div class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                                        ðŸ“± Subcontractor Portal
                                    </div>
                                </div>
                            </div>
                            <span id="job-status" class="px-2 sm:px-3 py-1 sm:py-2 rounded-full text-xs sm:text-sm font-medium border"></span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-2 sm:gap-3">
                            <button id="call-btn" class="flex items-center space-x-2 btn-success text-white px-3 sm:px-4 py-2 rounded-lg font-medium shadow-md mobile-button">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                                <span class="hidden sm:inline">Call Customer</span>
                                <span class="sm:hidden">Call</span>
                            </button>
                            <button id="navigate-btn" class="flex items-center space-x-2 btn-primary text-white px-3 sm:px-4 py-2 rounded-lg font-medium shadow-md mobile-button">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span class="hidden sm:inline">Navigate</span>
                                <span class="sm:hidden">GPS</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
                <div class="space-y-6 sm:space-y-8">
                    <!-- Customer Information -->
                    <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-4 sm:p-6 lg:p-8">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center space-x-3">
                            <div class="bg-blue-100 p-2 rounded-lg">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <span>Customer Information</span>
                        </h2>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name</label>
                                    <p id="customer-name" class="text-base sm:text-lg font-semibold text-gray-900 bg-gray-50 p-3 rounded-lg"></p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                                        <p id="customer-phone" class="text-base sm:text-lg text-gray-900 flex-1 phone-input"></p>
                                        <button id="phone-btn" class="text-green-600 hover:text-green-800 p-2 hover:bg-green-50 rounded-lg transition-colors">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                    <div class="flex items-start space-x-3 bg-gray-50 p-3 rounded-lg">
                                        <p id="customer-address" class="text-gray-900 flex-1 leading-relaxed"></p>
                                        <button id="address-btn" class="text-blue-600 hover:text-blue-800 flex-shrink-0 p-2 hover:bg-blue-50 rounded-lg transition-colors">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Issue Description</label>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p id="customer-issue" class="text-gray-900 leading-relaxed"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Updates Form -->
                    <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-4 sm:p-6 lg:p-8">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center space-x-3">
                            <div class="bg-orange-100 p-2 rounded-lg">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <span>Update Job Status</span>
                        </h2>

                        <form id="job-form" class="space-y-4 sm:space-y-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Job Status</label>
                                    <select id="status-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-base">
                                        <option value="pending">Pending</option>
                                        <option value="assigned">Assigned</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Total Price</label>
                                    <div class="relative">
                                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                        <input id="price-input" type="number" step="0.01" min="0" class="pl-10 pr-4 py-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-base" placeholder="0.00">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Materials Used</label>
                                <textarea id="materials-input" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-base" placeholder="List materials and parts used..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Work Notes</label>
                                <textarea id="notes-input" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-base" placeholder="Describe the work performed, any issues encountered, or additional notes..."></textarea>
                            </div>

                            <button type="submit" id="update-btn" class="w-full btn-primary text-white px-6 py-4 rounded-lg font-medium shadow-lg text-base">
                                <span id="update-btn-text">Update Job</span>
                                <div id="update-btn-loading" class="hidden flex items-center justify-center space-x-2">
                                    <div class="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                                    <span>Updating...</span>
                                </div>
                            </button>
                        </form>
                    </div>

                    <!-- Current Job Details -->
                    <div id="current-details" class="bg-white rounded-2xl card-shadow border border-gray-200 p-4 sm:p-6 lg:p-8 hidden">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center space-x-3">
                            <div class="bg-purple-100 p-2 rounded-lg">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <span>Current Job Details</span>
                        </h2>

                        <div class="space-y-4">
                            <div id="current-materials" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Materials Used</label>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p id="current-materials-text" class="text-gray-900"></p>
                                </div>
                            </div>

                            <div id="current-price" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Price</label>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p id="current-price-text" class="text-xl sm:text-2xl font-bold text-green-600"></p>
                                </div>
                            </div>

                            <div id="current-notes" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Work Notes</label>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p id="current-notes-text" class="text-gray-900 leading-relaxed"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentJob = null;
        let supabase = null;

        // Enhanced mobile detection
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768);
        }

        // Phone number validation and formatting
        function validatePhoneNumber(phone) {
            if (!phone) return false;
            const cleaned = phone.replace(/\D/g, '');
            return cleaned.length === 10 || (cleaned.length === 11 && cleaned.startsWith('1'));
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const cleaned = phone.replace(/\D/g, '');
            
            if (cleaned.length === 10) {
                return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
            } else if (cleaned.length === 11 && cleaned.startsWith('1')) {
                return `+1 (${cleaned.slice(1, 4)}) ${cleaned.slice(4, 7)}-${cleaned.slice(7)}`;
            }
            
            return phone;
        }

        // Enhanced toast notifications
        function showToast(message, type = 'success', duration = 4000) {
            const toastId = type === 'success' ? 'success-toast' : 'error-toast';
            const messageId = type === 'success' ? 'success-message' : 'error-toast-message';
            
            const toast = document.getElementById(toastId);
            const messageEl = document.getElementById(messageId);
            
            if (toast && messageEl) {
                messageEl.textContent = message;
                toast.classList.remove('hidden');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, duration);
            }
        }

        // Initialize Supabase client with enhanced configuration detection
        async function initializeSupabase() {
            try {
                // First try to get config from the main app if available
                try {
                    const response = await fetch('/api/config', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        timeout: 5000
                    });
                    
                    if (response.ok) {
                        const config = await response.json();
                        if (config.supabaseUrl && config.supabaseKey) {
                            supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey, {
                                auth: { 
                                    persistSession: false, 
                                    autoRefreshToken: false 
                                }
                            });
                            console.log('Supabase initialized from API config');
                            return true;
                        }
                    }
                } catch (apiError) {
                    console.log('API config not available, checking for embedded config');
                }

                // Try to get configuration from the current page's environment
                // This will work when the page is served from the same domain
                if (window.location.hostname !== 'your-app-domain.com') {
                    // We're on a real domain, try to use relative API calls
                    console.log('Real domain detected, using relative API calls');
                    return true; // We'll handle this in the job loading function
                }

                console.log('No Supabase configuration available');
                return false;
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                return false;
            }
        }

        // Get job ID from URL parameters with enhanced parsing
        function getJobIdFromUrl() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const jobId = urlParams.get('id');
                
                if (!jobId) {
                    // Try to get from hash if not in query params
                    const hash = window.location.hash;
                    const hashMatch = hash.match(/id=([^&]+)/);
                    if (hashMatch) {
                        return hashMatch[1];
                    }
                }
                
                return jobId;
            } catch (error) {
                console.error('Error parsing job ID from URL:', error);
                return null;
            }
        }

        // Enhanced format functions
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Invalid Date';
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'Invalid Date';
            }
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'assigned': 'bg-blue-100 text-blue-800 border-blue-200',
                'in_progress': 'bg-orange-100 text-orange-800 border-orange-200',
                'completed': 'bg-green-100 text-green-800 border-green-200',
                'cancelled': 'bg-red-100 text-red-800 border-red-200'
            };
            return colors[status] || 'bg-gray-100 text-gray-800 border-gray-200';
        }

        // Enhanced element visibility functions
        function showElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.remove('hidden');
            }
        }

        function hideElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.add('hidden');
            }
        }

        // Enhanced job loading with multiple fallback methods
        async function loadJob() {
            const jobId = getJobIdFromUrl();
            if (!jobId) {
                showJobError('No job ID provided in URL. Please check the link and try again.');
                return;
            }

            try {
                console.log('Loading job with ID:', jobId);
                console.log('User agent:', navigator.userAgent);
                console.log('Is mobile:', isMobileDevice());
                console.log('Current URL:', window.location.href);

                let job = null;

                // Method 1: Try direct API call to the current domain
                try {
                    console.log('Attempting API call to current domain...');
                    const response = await fetch(`/api/jobs/${jobId}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        job = await response.json();
                        console.log('Job loaded via API:', job);
                    } else {
                        console.log('API call failed with status:', response.status);
                    }
                } catch (apiError) {
                    console.log('API call failed:', apiError);
                }

                // Method 2: Try Supabase direct connection if API failed
                if (!job) {
                    const supabaseInitialized = await initializeSupabase();
                    
                    if (supabaseInitialized && supabase) {
                        try {
                            console.log('Attempting Supabase direct connection...');
                            const { data, error } = await supabase
                                .from('jobs')
                                .select(`
                                    *,
                                    subcontractor:subcontractors(*)
                                `)
                                .eq('job_id', jobId)
                                .single();

                            if (error) throw error;
                            job = data;
                            console.log('Job loaded via Supabase:', job);
                        } catch (supabaseError) {
                            console.log('Supabase connection failed:', supabaseError);
                        }
                    }
                }

                if (!job) {
                    throw new Error('Unable to load job data. Please check your internet connection and try again.');
                }

                currentJob = job;
                displayJob(job);
                
            } catch (error) {
                console.error('Error loading job:', error);
                showJobError(`Failed to load job: ${error.message}`);
            }
        }

        // Enhanced job display function
        function displayJob(job) {
            try {
                // Header
                const titleEl = document.getElementById('job-title');
                const dateEl = document.getElementById('job-date');
                const statusEl = document.getElementById('job-status');
                
                if (titleEl) titleEl.textContent = job.job_id || 'Unknown Job';
                if (dateEl) dateEl.textContent = formatDate(job.created_at);
                
                if (statusEl) {
                    const statusText = job.status ? 
                        job.status.charAt(0).toUpperCase() + job.status.slice(1).replace('_', ' ') : 
                        'Unknown';
                    statusEl.textContent = statusText;
                    statusEl.className = `px-2 sm:px-3 py-1 sm:py-2 rounded-full text-xs sm:text-sm font-medium border ${getStatusColor(job.status)}`;
                }

                // Customer info with phone validation
                const customerNameEl = document.getElementById('customer-name');
                const customerPhoneEl = document.getElementById('customer-phone');
                const customerAddressEl = document.getElementById('customer-address');
                const customerIssueEl = document.getElementById('customer-issue');
                
                if (customerNameEl) customerNameEl.textContent = job.customer_name || 'Unknown Customer';
                if (customerPhoneEl) {
                    const formattedPhone = formatPhoneNumber(job.customer_phone);
                    customerPhoneEl.textContent = formattedPhone;
                    
                    // Add validation styling
                    if (validatePhoneNumber(job.customer_phone)) {
                        customerPhoneEl.classList.add('text-green-700');
                        customerPhoneEl.classList.remove('text-red-700');
                    } else {
                        customerPhoneEl.classList.add('text-red-700');
                        customerPhoneEl.classList.remove('text-green-700');
                    }
                }
                if (customerAddressEl) customerAddressEl.textContent = job.customer_address || 'No address provided';
                if (customerIssueEl) customerIssueEl.textContent = job.customer_issue || 'No issue description provided';

                // Form fields
                const statusSelect = document.getElementById('status-select');
                const materialsInput = document.getElementById('materials-input');
                const priceInput = document.getElementById('price-input');
                const notesInput = document.getElementById('notes-input');
                
                if (statusSelect) statusSelect.value = job.status || 'pending';
                if (materialsInput) materialsInput.value = job.materials || '';
                if (priceInput) priceInput.value = job.price || '';
                if (notesInput) notesInput.value = job.notes || '';

                // Current details
                updateCurrentDetails(job);

                // Setup event listeners
                setupEventListeners(job);

                // Show content
                hideElement('loading');
                showElement('content');
                
                console.log('Job display completed successfully');
            } catch (error) {
                console.error('Error displaying job:', error);
                showJobError('Error displaying job information');
            }
        }

        // Enhanced error display
        function showJobError(message) {
            const errorMessageEl = document.getElementById('error-message');
            if (errorMessageEl) {
                errorMessageEl.textContent = message;
            }
            hideElement('loading');
            showElement('error');
        }

        // Enhanced event listeners setup
        function setupEventListeners(job) {
            try {
                // Call customer buttons
                const callBtn = document.getElementById('call-btn');
                const phoneBtn = document.getElementById('phone-btn');
                
                const callHandler = () => {
                    if (job.customer_phone) {
                        if (validatePhoneNumber(job.customer_phone)) {
                            window.location.href = `tel:${job.customer_phone}`;
                            showToast(`Calling ${job.customer_name}...`, 'success', 2000);
                        } else {
                            showToast('Invalid phone number format', 'error', 3000);
                        }
                    }
                };
                
                if (callBtn) callBtn.addEventListener('click', callHandler);
                if (phoneBtn) phoneBtn.addEventListener('click', callHandler);

                // Navigate buttons
                const navigateBtn = document.getElementById('navigate-btn');
                const addressBtn = document.getElementById('address-btn');
                
                const navigateHandler = () => {
                    if (job.customer_address) {
                        const encodedAddress = encodeURIComponent(job.customer_address);
                        
                        if (isMobileDevice()) {
                            // Enhanced mobile navigation with multiple fallbacks
                            const mapsUrl = `maps://maps.google.com/maps?q=${encodedAddress}`;
                            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
                            const wazeUrl = `https://waze.com/ul?q=${encodedAddress}`;
                            
                            // Try to open native maps app
                            const link = document.createElement('a');
                            link.href = mapsUrl;
                            link.click();
                            
                            // Fallback to web maps after a short delay
                            setTimeout(() => {
                                window.open(googleMapsUrl, '_blank');
                            }, 1500);
                        } else {
                            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
                            window.open(googleMapsUrl, '_blank');
                        }
                        
                        showToast('Opening navigation...', 'success', 2000);
                    }
                };

                if (navigateBtn) navigateBtn.addEventListener('click', navigateHandler);
                if (addressBtn) addressBtn.addEventListener('click', navigateHandler);

                // Form submission
                const jobForm = document.getElementById('job-form');
                if (jobForm) {
                    jobForm.addEventListener('submit', handleFormSubmit);
                }

                // Price input validation
                const priceInput = document.getElementById('price-input');
                if (priceInput) {
                    priceInput.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        if (value < 0) {
                            e.target.value = 0;
                            showToast('Price cannot be negative', 'error', 2000);
                        }
                    });
                }
                
                console.log('Event listeners setup completed');
            } catch (error) {
                console.error('Error setting up event listeners:', error);
            }
        }

        // Enhanced form submission with multiple update methods
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!currentJob) {
                showToast('Unable to update job. Please refresh and try again.', 'error');
                return;
            }

            const statusSelect = document.getElementById('status-select');
            const materialsInput = document.getElementById('materials-input');
            const priceInput = document.getElementById('price-input');
            const notesInput = document.getElementById('notes-input');
            
            // Validate price input
            const priceValue = priceInput?.value;
            if (priceValue && (isNaN(parseFloat(priceValue)) || parseFloat(priceValue) < 0)) {
                showToast('Please enter a valid price (must be 0 or greater)', 'error');
                return;
            }
            
            const formData = {
                status: statusSelect?.value || currentJob.status,
                materials: materialsInput?.value || null,
                price: priceValue ? parseFloat(priceValue) : null,
                notes: notesInput?.value || null
            };

            // Show loading state
            const updateBtn = document.getElementById('update-btn');
            const updateBtnText = document.getElementById('update-btn-text');
            const updateBtnLoading = document.getElementById('update-btn-loading');
            
            if (updateBtnText) updateBtnText.classList.add('hidden');
            if (updateBtnLoading) updateBtnLoading.classList.remove('hidden');
            if (updateBtn) updateBtn.disabled = true;

            try {
                console.log('Updating job with data:', formData);

                let success = false;

                // Method 1: Try API call first
                try {
                    const response = await fetch(`/api/jobs/${currentJob.job_id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...formData,
                            updated_at: new Date().toISOString()
                        })
                    });

                    if (response.ok) {
                        const updatedJob = await response.json();
                        currentJob = updatedJob;
                        success = true;
                        console.log('Job updated via API');
                    }
                } catch (apiError) {
                    console.log('API update failed, trying Supabase:', apiError);
                }

                // Method 2: Try Supabase if API failed
                if (!success && supabase) {
                    try {
                        const { data, error } = await supabase
                            .from('jobs')
                            .update({
                                ...formData,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', currentJob.id)
                            .select(`
                                *,
                                subcontractor:subcontractors(*)
                            `)
                            .single();

                        if (error) throw error;
                        
                        console.log('Job updated via Supabase:', data);
                        currentJob = data;
                        success = true;
                    } catch (supabaseError) {
                        console.log('Supabase update failed:', supabaseError);
                    }
                }

                if (success) {
                    // Update display
                    const statusEl = document.getElementById('job-status');
                    if (statusEl) {
                        const statusText = formData.status.charAt(0).toUpperCase() + formData.status.slice(1).replace('_', ' ');
                        statusEl.textContent = statusText;
                        statusEl.className = `px-2 sm:px-3 py-1 sm:py-2 rounded-full text-xs sm:text-sm font-medium border ${getStatusColor(formData.status)}`;
                    }

                    // Update current details
                    updateCurrentDetails(formData);
                    
                    // Show success message
                    const updatedFields = Object.keys(formData).filter(key => formData[key] !== null && formData[key] !== '');
                    const message = updatedFields.length > 0 ? 
                        `Job updated successfully! Updated: ${updatedFields.join(', ')}` : 
                        'Job updated successfully!';
                    showToast(message, 'success', 5000);
                } else {
                    throw new Error('All update methods failed');
                }
                
            } catch (error) {
                console.error('Error updating job:', error);
                showToast('Failed to update job. Please check your connection and try again.', 'error', 6000);
            } finally {
                // Hide loading state
                if (updateBtnText) updateBtnText.classList.remove('hidden');
                if (updateBtnLoading) updateBtnLoading.classList.add('hidden');
                if (updateBtn) updateBtn.disabled = false;
            }
        }

        // Enhanced current details update
        function updateCurrentDetails(data) {
            try {
                const currentDetailsEl = document.getElementById('current-details');
                const currentMaterialsEl = document.getElementById('current-materials');
                const currentPriceEl = document.getElementById('current-price');
                const currentNotesEl = document.getElementById('current-notes');
                const currentMaterialsTextEl = document.getElementById('current-materials-text');
                const currentPriceTextEl = document.getElementById('current-price-text');
                const currentNotesTextEl = document.getElementById('current-notes-text');
                
                let hasDetails = false;

                if (data.materials) {
                    if (currentMaterialsTextEl) currentMaterialsTextEl.textContent = data.materials;
                    if (currentMaterialsEl) currentMaterialsEl.classList.remove('hidden');
                    hasDetails = true;
                } else {
                    if (currentMaterialsEl) currentMaterialsEl.classList.add('hidden');
                }
                
                if (data.price) {
                    if (currentPriceTextEl) currentPriceTextEl.textContent = `$${parseFloat(data.price).toFixed(2)}`;
                    if (currentPriceEl) currentPriceEl.classList.remove('hidden');
                    hasDetails = true;
                } else {
                    if (currentPriceEl) currentPriceEl.classList.add('hidden');
                }
                
                if (data.notes) {
                    if (currentNotesTextEl) currentNotesTextEl.textContent = data.notes;
                    if (currentNotesEl) currentNotesEl.classList.remove('hidden');
                    hasDetails = true;
                } else {
                    if (currentNotesEl) currentNotesEl.classList.add('hidden');
                }

                if (currentDetailsEl) {
                    if (hasDetails) {
                        currentDetailsEl.classList.remove('hidden');
                    } else {
                        currentDetailsEl.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error updating current details:', error);
            }
        }

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing job view...');
            console.log('Current URL:', window.location.href);
            console.log('User agent:', navigator.userAgent);
            console.log('Screen size:', window.innerWidth + 'x' + window.innerHeight);
            
            // Add mobile-specific optimizations
            if (isMobileDevice()) {
                document.body.classList.add('mobile-device');
                
                // Prevent zoom on input focus for iOS
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.style.fontSize = '16px';
                });
                
                // Add viewport meta tag if not present
                let viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no');
                }
            }
            
            loadJob();
        });

        // Enhanced error handling for unhandled errors
        window.addEventListener('error', function(e) {
            console.error('Unhandled error:', e.error);
            showToast('An unexpected error occurred. Please refresh the page.', 'error', 8000);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showToast('A network error occurred. Please check your connection.', 'error', 8000);
        });

        // Add network status monitoring
        window.addEventListener('online', function() {
            showToast('Connection restored!', 'success', 3000);
        });

        window.addEventListener('offline', function() {
            showToast('Connection lost. Please check your internet connection.', 'error', 8000);
        });
    </script>
</body>
</html>